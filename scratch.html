<script>
  document.getElementById("text01").innerHTML =
    "<canvas id='cv' width='640' height='640'></canvas><video style='display:none' id='video' width='320' height='320' autoplay ><br></video><br><canvas style='padding:10px' id='canvas' width='320' height='320'></canvas>";

  var cv = document.getElementById("cv");
  var ctx = cv.getContext("2d");

  var cvWidth = cv.width;
  var cvHeight = cv.height;
  var x = 1;
  var y = 1;
  var h = 1;
  var w = 1;
  var shape = 1;
  var threshold = 50;
  var motion = [];
  var old = [];
  var inMemoryStorage = [];
  var fullLoop = 0;

  cv.addEventListener("click", function(e) {
    var bound = cv.getBoundingClientRect();
    var x = e.clientX - bound.left;
    var y = e.clientY - bound.top;

    var pix = ctx.getImageData(x, y, 1, 1).data;
    var now = Date.now();
    var qoords = {
      coords: { x: x, y: y },
      pix: pix,
      time: now
    };
    lib.current = qoords;
    document.getElementById("text04").innerHTML = JSON.stringify(qoords);

    function hood(x, y, size) {
      //var size = 5;
      var d = Math.floor(size / 2);
      var darr = [];
      for (var dx = -d; dx <= d; dx++) {
        for (var dy = -d; dy <= d; dy++) {
          if (dx || dy) {
            var x = x + dx;
            var y = y + dy;
            var pix = ctx.getImageData(x, y, 1, 1).data;
            darr.push(pix);
          }
        }
      }
      console.log(darr);
    }
    hood(x, y, 3);
  });
  window.lib = {
    start: function(e) {
      var video = document.getElementById("video");
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices
          .getUserMedia({ video: true })
          .then(function(stream) {
            //video.src = window.URL.createObjectURL(stream);
            video.srcObject = stream;
            video.play();
          });
      }

      var canvas = document.getElementById("canvas");
      var context = canvas.getContext("2d");
      var video = document.getElementById("video");
      lib.animate();
    },
    animate: function(e) {
      function getColor() {
        var letters = "0123456789ABCDEF";
        var color = "#";
        for (var i = 0; i < 8; i++) {
          color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
      }

      function draw(x, y, h, w, c) {
        for (let i = 0; i < c; i++) {
          for (let j = 0; j < c; j++) {
            function rgb2hex(red, green, blue) {
              var rgb = blue | (green << 8) | (red << 16);
              return "#" + (0x1000000 + rgb).toString(16).slice(1);
            }
            var pix = ctx.getImageData(x, y, 1, 1).data;

            //var Image = ctx.getImageData(x, y, cvWidth, cvHeight).data;
            //localStorage.setItem('Image', Image);

            ctx.fillStyle = getColor();
            ctx.fillRect(x + j, y + i, shape, shape);
            var pos = x + y;
            if (old[pos] && old[pos].r - pix[3] > threshold) {
              motion.push({
                x: x,
                y: y,
                r: pix[0],
                g: pix[1],
                b: pix[2],
                a: pix[3]
              });
            }
            old[pos] = {
              x: x,
              y: y,
              r: pix[0],
              g: pix[1],
              b: pix[2],
              a: pix[3]
            };
          }
        }
      }
      ctx.drawImage(video, 0, 0, cvWidth, cvHeight);
      ctx.drawImage(document.getElementsByTagName("video")[0],0,0,cvWidth,cvHeight);

      x = x + 1;
      y = y + 1;
      
      var rgba = ctx.getImageData(x, y, 1, 1).data;
      var xyImageData = x+","+y+","+rgba;
      var xyImageDataJson = xyImageData.split(',');
      //only640thenreset
      
      if (y > cvHeight) {
        
        y = y - cvHeight;
        fullLoop = fullLoop + 1;
        lib[fullLoop] = inMemoryStorage;
      inMemoryStorage = [];
      } 
            inMemoryStorage.push(xyImageDataJson);

      if (x > cvWidth) {
        x = x - cvWidth;
      }
         
      draw(x,y,shape,shape,16);
      
      document.getElementById("text04").innerHTML = lib[fullLoop];
      requestAnimationFrame(lib.animate);
    },
    subscribe: function(e) {
      var amount = e;
      StripeCheckout.configure({
        key: "pk_live_ObaqTuXmpyisKC1YG5PmSwtH",
        key2: "sk_live_1a8TlJBfRCKe1y5dceVR4wrK00KUm4VnND",
        image:
          "https://s3.amazonaws.com/stripe-uploads/acct_15mFAPBHEFYVkz22merchant-icon-1463599844790-pilot.png",
        locale: "auto",
        token: function(token) {
          var data = new FormData();
          data.append("json", JSON.stringify(token));
          var val = window.location;

          fetch("/", {
            method: "post",
            uin: val,
            mode: "no-cors",
            body: JSON.stringify({
              type: "commit",
              query: val,
              data: data,
              modifier: window.commitpath
            })
          }).then(function(response) {
            var decoder = new TextDecoder();
            var reader = response.body.getReader();
            reader.read().then(function processResult(result) {
              if (result.done) return;
              var result = decoder.decode(result.value, {
                stream: true
              });
              console.log(result);
            });
          });
        }
      }).open({
        name: "Untitled",
        description: "Commercial License",
        currency: "cad",
        amount: amount
      });
    }
  };
  lib.start();
</script>
<script src="https://checkout.stripe.com/checkout.js"></script>
